function mJacobianoInverso(Formacao)

posFormacao = Formacao.pPos.q;
velFormacao = Formacao.pPos.dq;

ph = posFormacao(4);
th = posFormacao(5);
ps = posFormacao(6);
p  = posFormacao(7);
q  = posFormacao(8);
b  = posFormacao(9);

% Verificação de sequência dos robôs para criação da estrutura
seq = cross(Formacao.pPos.xd(4:6)-Formacao.pPos.xd(1:3),Formacao.pPos.xd(7:9)-Formacao.pPos.xd(1:3));
if seq(3) >= 0
    % Anti-horária: ABC -> z > 0
    Jinv = [
        1, 0, 0,                                                                                                                                                                                        0,                                                                                                                                                                                                         -(cos(ps)*sin(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                             -(cos(th)*sin(ps)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(ps)*cos(th)*(p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(ps)*cos(th)*(q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(p*q*cos(ps)*sin(b)*cos(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2));...
        0, 1, 0,                                                                                                                                                                                        0,                                                                                                                                                                                                         -(sin(ps)*sin(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                              (cos(ps)*cos(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(th)*sin(ps)*(p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(th)*sin(ps)*(q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(p*q*sin(b)*cos(th)*sin(ps))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2));...
        0, 0, 1,                                                                                                                                                                                        0,                                                                                                                                                                                                                 -(cos(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -(sin(th)*(p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -(sin(th)*(q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (p*q*sin(b)*sin(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2));...
        1, 0, 0,    ((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(sin(ph)*sin(ps) + cos(ph)*cos(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,     (cos(ps)*sin(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(ps)*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,     (cos(th)*sin(ps)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - ((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,         (cos(ps)*cos(th)*(p/2 + (q*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(2*p - q*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (cos(ps)*cos(th)*(8*p + 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (3*p*q^2*(2*p^2 + q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),         (cos(ps)*cos(th)*(4*q - 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(q/2 - p*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) + (cos(ps)*cos(th)*(q/2 + (p*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q*(2*p^2 + q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),       (p*q*cos(ps)*sin(b)*cos(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*p*q*sin(b)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (p*q*cos(ps)*sin(b)*cos(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p^2*q^2*sin(b)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^3*q - p*q^3 + 4*p^4*cos(b) + q^4*cos(b) - 3*p^2*q^2*cos(b) - p*q^3*cos(b)^2 + 2*p^3*q*cos(b)^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2);...
        0, 1, 0,   -((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ps)*sin(ph) - cos(ph)*sin(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,     (sin(ps)*sin(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(th)*sin(ph)*sin(ps)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,   - ((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3 - (cos(ps)*cos(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),         (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(2*p - q*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (cos(th)*sin(ps)*(8*p + 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(th)*sin(ps)*(p/2 + (q*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p*q^2*(2*p^2 + q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),         (cos(th)*sin(ps)*(4*q - 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(q/2 - p*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) + (cos(th)*sin(ps)*(q/2 + (p*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p^2*q*(2*p^2 + q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),       (p*q*sin(b)*cos(th)*sin(ps))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*p*q*sin(b)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (p*q*sin(b)*cos(th)*sin(ps)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q^2*sin(b)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^3*q - p*q^3 + 4*p^4*cos(b) + q^4*cos(b) - 3*p^2*q^2*cos(b) - p*q^3*cos(b)^2 + 2*p^3*q*cos(b)^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2);...
        0, 0, 1,                                (cos(ph)*cos(th)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,                     (cos(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (sin(ph)*sin(th)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                 0,                                                                                   (sin(th)*(4*p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (sin(th)*(p/2 + (q*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (2*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(2*p - q*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) + (3*p*q^2*cos(th)*sin(ph)*(2*p^2 + q^2)*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),                                                                                 (2*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(q/2 - p*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (sin(th)*(q/2 + (p*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (sin(th)*(4*q - 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (3*p^2*q*cos(th)*sin(ph)*(2*p^2 + q^2)*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),                                                                               (p*q*sin(b)*sin(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (p*q*sin(b)*sin(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*p*q*sin(b)*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) + (3*p^2*q^2*sin(b)*cos(th)*sin(ph)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^3*q - p*q^3 + 4*p^4*cos(b) + q^4*cos(b) - 3*p^2*q^2*cos(b) - p*q^3*cos(b)^2 + 2*p^3*q*cos(b)^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2);...
        1, 0, 0, -((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(sin(ph)*sin(ps) + cos(ph)*cos(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, (cos(ps)*sin(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (cos(ps)*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, ((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3 + (cos(th)*sin(ps)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)), (cos(ps)*cos(th)*(4*p - 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(p/2 - q*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) + (cos(ps)*cos(th)*(p/2 + (q*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p*q^2*(p^2 + 2*q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(2*q - p*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (cos(ps)*cos(th)*(8*q + 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(ps)*cos(th)*(q/2 + (p*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q*(p^2 + 2*q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (p*q*cos(ps)*sin(b)*cos(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*p*q*sin(b)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (p*q*cos(ps)*sin(b)*cos(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q^2*sin(b)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(2*p*q^3 - p^3*q + p^4*cos(b) + 4*q^4*cos(b) - 3*p^2*q^2*cos(b) + 2*p*q^3*cos(b)^2 - p^3*q*cos(b)^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2);...
        0, 1, 0,  ((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ps)*sin(ph) - cos(ph)*sin(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, (sin(ps)*sin(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (cos(th)*sin(ph)*sin(ps)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, ((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3 - (cos(ps)*cos(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)), (cos(th)*sin(ps)*(4*p - 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(p/2 - q*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) + (cos(th)*sin(ps)*(p/2 + (q*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p*q^2*(p^2 + 2*q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (cos(th)*sin(ps)*(q/2 + (p*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(2*q - p*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (cos(th)*sin(ps)*(8*q + 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (3*p^2*q*(p^2 + 2*q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (p*q*sin(b)*cos(th)*sin(ps))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*p*q*sin(b)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (p*q*sin(b)*cos(th)*sin(ps)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p^2*q^2*sin(b)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(2*p*q^3 - p^3*q + p^4*cos(b) + 4*q^4*cos(b) - 3*p^2*q^2*cos(b) + 2*p*q^3*cos(b)^2 - p^3*q*cos(b)^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2);...
        0, 0, 1,                             -(cos(ph)*cos(th)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3,                 (cos(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (sin(ph)*sin(th)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                 0,                                                                         (3*p*q^2*cos(th)*sin(ph)*(p^2 + 2*q^2)*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2) - (sin(th)*(p/2 + (q*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p/2 - q*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (sin(th)*(4*p - 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                           (sin(th)*(4*q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (sin(th)*(q/2 + (p*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(2*q - p*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (3*p^2*q*cos(th)*sin(ph)*(p^2 + 2*q^2)*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2),                                                                         (p*q*sin(b)*sin(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (p*q*sin(b)*sin(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*p*q*sin(b)*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (3*p^2*q^2*sin(b)*cos(th)*sin(ph)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(2*p*q^3 - p^3*q + p^4*cos(b) + 4*q^4*cos(b) - 3*p^2*q^2*cos(b) + 2*p*q^3*cos(b)^2 - p^3*q*cos(b)^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2)];
else
    % Horárica: ACB -> z < 0
    Jinv = [
        1, 0, 0,                                                                                                                                                                                        0,                                                                                                                                                                                                         -(cos(ps)*sin(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                               -(cos(th)*sin(ps)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(ps)*cos(th)*(p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(ps)*cos(th)*(q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(p*q*cos(ps)*sin(b)*cos(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2));...
        0, 1, 0,                                                                                                                                                                                        0,                                                                                                                                                                                                         -(sin(ps)*sin(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                (cos(ps)*cos(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(th)*sin(ps)*(p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (cos(th)*sin(ps)*(q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(p*q*sin(b)*cos(th)*sin(ps))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2));...
        0, 0, 1,                                                                                                                                                                                        0,                                                                                                                                                                                                                 -(cos(th)*(p^2 + 2*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                   0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -(sin(th)*(p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -(sin(th)*(q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (p*q*sin(b)*sin(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2));...
        1, 0, 0,   -((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(sin(ph)*sin(ps) + cos(ph)*cos(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,     (cos(ps)*sin(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (cos(ps)*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,       ((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3 + (cos(th)*sin(ps)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),         (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(2*p - q*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (cos(ps)*cos(th)*(8*p + 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(ps)*cos(th)*(p/2 + (q*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p*q^2*(2*p^2 + q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),         (cos(ps)*cos(th)*(4*q - 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(q/2 - p*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) + (cos(ps)*cos(th)*(q/2 + (p*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p^2*q*(2*p^2 + q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),       (p*q*cos(ps)*sin(b)*cos(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*p*q*sin(b)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (p*q*cos(ps)*sin(b)*cos(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q^2*sin(b)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^3*q - p*q^3 + 4*p^4*cos(b) + q^4*cos(b) - 3*p^2*q^2*cos(b) - p*q^3*cos(b)^2 + 2*p^3*q*cos(b)^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2);...
        0, 1, 0,    ((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ps)*sin(ph) - cos(ph)*sin(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,     (sin(ps)*sin(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (cos(th)*sin(ph)*sin(ps)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,       ((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3 - (cos(ps)*cos(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),         (cos(th)*sin(ps)*(p/2 + (q*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(2*p - q*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (cos(th)*sin(ps)*(8*p + 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (3*p*q^2*(2*p^2 + q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),         (cos(th)*sin(ps)*(4*q - 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(q/2 - p*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) + (cos(th)*sin(ps)*(q/2 + (p*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q*(2*p^2 + q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),       (p*q*sin(b)*cos(th)*sin(ps))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*p*q*sin(b)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (p*q*sin(b)*cos(th)*sin(ps)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p^2*q^2*sin(b)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^3*q - p*q^3 + 4*p^4*cos(b) + q^4*cos(b) - 3*p^2*q^2*cos(b) - p*q^3*cos(b)^2 + 2*p^3*q*cos(b)^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2);...
        0, 0, 1,                               -(cos(ph)*cos(th)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,                     (cos(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (sin(ph)*sin(th)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                   0,                                                                                   (sin(th)*(4*p + q*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (sin(th)*(p/2 + (q*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(2*p - q*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (3*p*q^2*cos(th)*sin(ph)*(2*p^2 + q^2)*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2),                                                                                 (3*p^2*q*cos(th)*sin(ph)*(2*p^2 + q^2)*(cos(b)^2 - 1)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^2 + cos(b)*p*q - q^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2) - (sin(th)*(q/2 + (p*cos(b))/2)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(q/2 - p*cos(b)))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (sin(th)*(4*q - 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)),                                                                               (p*q*sin(b)*sin(th)*(4*p^2 + 2*cos(b)*p*q - 2*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (p*q*sin(b)*sin(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*p*q*sin(b)*cos(th)*sin(ph)*(1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2))/(3*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)) - (3*p^2*q^2*sin(b)*cos(th)*sin(ph)*(4*p^2 - 4*cos(b)*p*q + q^2)^(1/2)*(2*p^3*q - p*q^3 + 4*p^4*cos(b) + q^4*cos(b) - 3*p^2*q^2*cos(b) - p*q^3*cos(b)^2 + 2*p^3*q*cos(b)^2))/((1 - (2*p^2 + cos(b)*p*q - q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(4*p^2 - 4*cos(b)*p*q + q^2)))^(1/2)*(4*p^4 + 4*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 - 2*p*q^3*cos(b) + q^4)^2);...
        1, 0, 0,  ((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(sin(ph)*sin(ps) + cos(ph)*cos(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, (cos(ps)*sin(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(ps)*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3,   (cos(th)*sin(ps)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - ((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, (cos(ps)*cos(th)*(4*p - 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(p/2 - q*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) + (cos(ps)*cos(th)*(p/2 + (q*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p*q^2*(p^2 + 2*q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (cos(ps)*cos(th)*(q/2 + (p*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(2*q - p*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (cos(ps)*cos(th)*(8*q + 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (3*p^2*q*(p^2 + 2*q^2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (p*q*cos(ps)*sin(b)*cos(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (2*p*q*sin(b)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (p*q*cos(ps)*sin(b)*cos(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p^2*q^2*sin(b)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(2*p*q^3 - p^3*q + p^4*cos(b) + 4*q^4*cos(b) - 3*p^2*q^2*cos(b) + 2*p*q^3*cos(b)^2 - p^3*q*cos(b)^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2);...
        0, 1, 0, -((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ps)*sin(ph) - cos(ph)*sin(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, (sin(ps)*sin(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(th)*sin(ph)*sin(ps)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3, - ((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*sin(ps) - cos(ps)*sin(ph)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3 - (cos(ps)*cos(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)), (cos(th)*sin(ps)*(4*p - 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(p/2 - q*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) + (cos(th)*sin(ps)*(p/2 + (q*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (3*p*q^2*(p^2 + 2*q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (2*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(2*q - p*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (cos(th)*sin(ps)*(8*q + 2*p*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (cos(th)*sin(ps)*(q/2 + (p*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q*(p^2 + 2*q^2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2), (p*q*sin(b)*cos(th)*sin(ps))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*p*q*sin(b)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (p*q*sin(b)*cos(th)*sin(ps)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (3*p^2*q^2*sin(b)*(cos(ph)*cos(ps) + sin(ph)*sin(ps)*sin(th))*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(2*p*q^3 - p^3*q + p^4*cos(b) + 4*q^4*cos(b) - 3*p^2*q^2*cos(b) + 2*p*q^3*cos(b)^2 - p^3*q*cos(b)^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2);...
        0, 0, 1,                              (cos(ph)*cos(th)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3,                 (cos(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (sin(ph)*sin(th)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2))/3,                                                                                                                                                                                                                                                                                   0,                                                                         (2*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p/2 - q*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) - (sin(th)*(p/2 + (q*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (sin(th)*(4*p - 2*q*cos(b)))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (3*p*q^2*cos(th)*sin(ph)*(p^2 + 2*q^2)*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2),                                                                           (sin(th)*(4*q + p*cos(b)))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) - (sin(th)*(q/2 + (p*cos(b))/2)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) + (2*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(2*q - p*cos(b)))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) + (3*p^2*q*cos(th)*sin(ph)*(p^2 + 2*q^2)*(cos(b)^2 - 1)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(- p^2 + cos(b)*p*q + 2*q^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2),                                                                         (p*q*sin(b)*sin(th)*(- 2*p^2 + 2*cos(b)*p*q + 4*q^2))/(6*(p^2 + 2*cos(b)*p*q + q^2)^(3/2)) - (p*q*sin(b)*sin(th))/(3*(p^2 + 2*cos(b)*p*q + q^2)^(1/2)) + (2*p*q*sin(b)*cos(th)*sin(ph)*(1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2))/(3*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)) + (3*p^2*q^2*sin(b)*cos(th)*sin(ph)*(p^2 - 4*cos(b)*p*q + 4*q^2)^(1/2)*(2*p*q^3 - p^3*q + p^4*cos(b) + 4*q^4*cos(b) - 3*p^2*q^2*cos(b) + 2*p*q^3*cos(b)^2 - p^3*q*cos(b)^2))/((1 - (- p^2 + cos(b)*p*q + 2*q^2)^2/((p^2 + 2*cos(b)*p*q + q^2)*(p^2 - 4*cos(b)*p*q + 4*q^2)))^(1/2)*(p^4 - 2*p^3*q*cos(b) - 8*p^2*q^2*cos(b)^2 + 5*p^2*q^2 + 4*p*q^3*cos(b) + 4*q^4)^2)];
    
end
velRobos = Jinv*velFormacao;

Formacao.pPos.dxr = velRobos;
end